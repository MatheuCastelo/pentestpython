import socket, threading, sys

'''
Função que recebe uma conecção e responde a mesma coisa que recebe
:isConnected = var bool define loop
:data = data send from client
:clientSocket = socket with client
'''
def clientHandler(clientSocket):
    isConnected = True
    while isConnected:
        data = clientSocket.recv(1024)
        if data:
            clientSocket.send(data)
        else:
            clientSocket.close()
            isConnected = False

'''
Create socket
Listening...
:s = var socket TCP
setsockopt = reutilize socket
'''
try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    s.bind(('', int(sys.argv[1]))) #tuple
    s.listen(10)
except:
    print(f"Error")
    s.close()

'''
Loop connection
:clientSocket = socket with client
:addr = tuple IP/PORT client
:clientIP = <-
:clientPort = <-
thread = callback function with args(tuple), can comunicate and process two or more clients at the same time
'''
while True:
    clientSocket, addr = s.accept()
    clientIp, clientPort = addr
    print(f"Client : {clientIp}:{clientPort}")

    threading.Thread(target=clientHandler, args=(clientSocket,)).start()

